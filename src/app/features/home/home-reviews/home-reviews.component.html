<section class="section-spacing reviews-section">
  <div class="page-container">
    <div class="reviews-grid">
      <div class="reviews-intro">
        <p class="reviews-eyebrow">
          {{ 'home.reviews.eyebrow' | translate }}
        </p>
        <h2 class="reviews-title">
          {{ 'home.reviews.title' | translate }}
        </h2>
        <p class="reviews-subtitle">
          {{ 'home.reviews.subtitle' | translate }}
        </p>

        <div class="reviews-metrics">
          <div class="reviews-metric">
            <div class="reviews-stars">
              @for (star of stars; track star) {
                <svg class="w-6 h-6" [class.dimmed]="star > math.round(averageRating())" fill="currentColor" viewBox="0 0 20 20">
                  <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                </svg>
              }
            </div>
            <div class="reviews-metric-copy">
              <div class="reviews-metric-value">{{ averageRating() | number:'1.1-1' }}</div>
              <div class="reviews-metric-label">{{ 'home.reviews.average_rating' | translate }}</div>
            </div>
          </div>
          <div class="reviews-metric">
            <div class="reviews-metric-value">{{ totalReviews() }}</div>
            <div class="reviews-metric-label">{{ 'home.reviews.published_reviews' | translate }}</div>
          </div>
        </div>
      </div>

      <div class="reviews-form-card">
        @if (submissionMessage()) {
          <div class="reviews-alert reviews-alert--success">
            {{ submissionMessage() }}
          </div>
        }
        @if (submissionError()) {
          <div class="reviews-alert reviews-alert--error">
            {{ submissionError() }}
          </div>
        }

        @if (currentUser()) {
          <div class="reviews-form">
            <div>
              <div class="reviews-label">{{ 'home.reviews.rate_experience' | translate }}</div>
              <div class="reviews-rating-picker">
                @for (star of stars; track star) {
                  <button
                    type="button"
                    class="reviews-rating-button"
                    [class.is-active]="star <= ratingInput()"
                    (click)="selectRating(star)"
                    [disabled]="isSubmitting()"
                    [attr.aria-label]="'home.reviews.rate_stars' | translate:{stars: star}">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                      <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                    </svg>
                  </button>
                }
              </div>
            </div>

            <div>
              <label class="reviews-label" for="review-comment">
                {{ 'home.reviews.share_testimonial' | translate }}
              </label>
              <textarea
                id="review-comment"
                name="review-comment"
                rows="4"
                [placeholder]="'home.reviews.testimonial_placeholder' | translate"
                [ngModel]="commentInput()"
                (ngModelChange)="commentInput.set($event)"
                [disabled]="isSubmitting()"
                class="reviews-textarea"></textarea>
              <div class="reviews-help">
                {{ 'home.reviews.testimonial_help' | translate }}
              </div>
            </div>

            <div class="reviews-actions">
              <button
                type="button"
                class="reviews-btn reviews-btn--primary"
                (click)="submitReview()"
                [disabled]="isSubmitting()">
                @if (isSubmitting()) {
                  <div class="app-spinner" style="--spinner-size: 72px;"><img src="/Logo Clear.png" alt="Loading" width="96" height="96"></div>
                  {{ 'home.reviews.saving_review' | translate }}
                } @else if (userReview()) {
                  {{ 'home.reviews.update_review' | translate }}
                } @else {
                  {{ 'home.reviews.publish_review' | translate }}
                }
              </button>

              @if (userReview()) {
                <button
                  type="button"
                  class="reviews-btn reviews-btn--ghost"
                  (click)="deleteReview()"
                  [disabled]="isSubmitting()">
                  {{ 'home.reviews.delete_review' | translate }}
                </button>
              }
            </div>
          </div>
        } @else {
          <div class="reviews-signin">
            <h3>{{ 'home.reviews.sign_in_title' | translate }}</h3>
            <p>
              {{ 'home.reviews.sign_in_desc' | translate }}
            </p>
            <a
              routerLink="/client/login"
              class="reviews-btn reviews-btn--primary reviews-btn--wide">
              {{ 'home.reviews.sign_in_button' | translate }}
            </a>
            <p class="reviews-signin-hint">{{ 'home.reviews.no_account' | translate }} <a routerLink="/client/register">{{ 'home.reviews.create_account' | translate }}</a></p>
          </div>
        }
      </div>
    </div>

    <div class="reviews-list">
      @if (displayedReviews().length) {
        <div class="reviews-card-grid">
          @for (review of displayedReviews(); track trackByReviewId($index, review)) {
            <article class="reviews-card">
              <div class="flex items-center gap-3 mb-4">
                <div class="reviews-avatar">
                  {{ review.displayName | slice:0:1 }}
                </div>
                <div>
                  <div class="reviews-name">{{ review.displayName }}</div>
                  <div class="reviews-mini-stars">
                    @for (star of stars; track star) {
                      <svg class="w-3.5 h-3.5" [class.dimmed]="star > review.rating" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                      </svg>
                    }
                  </div>
                </div>
              </div>
              <p class="reviews-comment">{{ review.comment }}</p>
              <div class="reviews-date">
                {{ (review.updatedAt || review.createdAt) | date:'mediumDate' }}
              </div>
            </article>
          }
        </div>
      } @else {
        <div class="reviews-empty">
          <p class="text-lg">{{ 'home.reviews.no_reviews_title' | translate }}</p>
          <p class="text-sm mt-2">{{ 'home.reviews.no_reviews_desc' | translate }}</p>
        </div>
      }
    </div>
  </div>
</section>
